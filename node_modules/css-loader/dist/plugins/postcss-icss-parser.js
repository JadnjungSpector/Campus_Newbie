"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _postcss = _interopRequireDefault(require("postcss"));

<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
var _postcssValueParser = _interopRequireDefault(require("postcss-value-parser"));

var _icssUtils = require("icss-utils");

var _loaderUtils = _interopRequireDefault(require("loader-utils"));
=======
var _icssUtils = require("icss-utils");

var _loaderUtils = require("loader-utils");
>>>>>>> cbaeadb69664be713d49558df22b6f02c48f3384
=======
=======
>>>>>>> ee12506f5 (figuring out lint)
=======
>>>>>>> bda8256cb (figuring out lint)
var _icssUtils = require("icss-utils");

var _loaderUtils = require("loader-utils");
=======
=======
>>>>>>> 6be43a322 (figuring out lint)
=======
>>>>>>> 5209f27ef (figuring out lint)
var _postcssValueParser = _interopRequireDefault(require("postcss-value-parser"));

var _icssUtils = require("icss-utils");

var _loaderUtils = _interopRequireDefault(require("loader-utils"));
<<<<<<< HEAD
>>>>>>> 6be43a322 (figuring out lint)
=======
<<<<<<< HEAD
>>>>>>> 6be43a322 (figuring out lint)
<<<<<<< HEAD
>>>>>>> 84b8e337c (figuring out lint)
=======
=======
var _icssUtils = require("icss-utils");

var _loaderUtils = require("loader-utils");
>>>>>>> cbaeadb69664be713d49558df22b6f02c48f3384
=======
var _icssUtils = require("icss-utils");

var _loaderUtils = require("loader-utils");
=======
var _postcssValueParser = _interopRequireDefault(require("postcss-value-parser"));

var _icssUtils = require("icss-utils");

var _loaderUtils = _interopRequireDefault(require("loader-utils"));
>>>>>>> 6be43a322 (figuring out lint)
>>>>>>> 84b8e337c (figuring out lint)
>>>>>>> 5209f27ef (figuring out lint)
>>>>>>> bda8256cb (figuring out lint)

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const pluginName = 'postcss-icss-parser';

<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
=======
=======
>>>>>>> bda8256cb (figuring out lint)
var _default = _postcss.default.plugin(pluginName, () => function process(css, result) {
  const imports = {};
  const icss = (0, _icssUtils.extractICSS)(css);
  const exports = icss.icssExports;
  Object.keys(icss.icssImports).forEach(key => {
    const url = _loaderUtils.default.parseString(key);

    Object.keys(icss.icssImports[key]).forEach(prop => {
      const index = Object.keys(imports).length;
      imports[`$${prop}`] = index;
      result.messages.push({
        pluginName,
        type: 'icss-import',
        item: {
          url,
          export: icss.icssImports[key][prop],
          index
        }
      });
      const alreadyIncluded = result.messages.find(message => message.pluginName === pluginName && message.type === 'import' && message.item.url === url && message.item.media === '');

      if (alreadyIncluded) {
        return;
      }

      result.messages.push({
        pluginName,
        type: 'import',
        item: {
          url,
          media: ''
=======
=======
>>>>>>> 84b8e337c (figuring out lint)
<<<<<<< HEAD
=======
>>>>>>> ee12506f5 (figuring out lint)
=======
>>>>>>> 5209f27ef (figuring out lint)
>>>>>>> bda8256cb (figuring out lint)
function normalizeIcssImports(icssImports) {
  return Object.keys(icssImports).reduce((accumulator, url) => {
    const tokensMap = icssImports[url];
    const tokens = Object.keys(tokensMap);

    if (tokens.length === 0) {
      return accumulator;
    }

    const normalizedUrl = (0, _loaderUtils.urlToRequest)(url);

    if (!accumulator[normalizedUrl]) {
      // eslint-disable-next-line no-param-reassign
      accumulator[normalizedUrl] = tokensMap;
    } else {
      // eslint-disable-next-line no-param-reassign
      accumulator[normalizedUrl] = { ...accumulator[normalizedUrl],
        ...tokensMap
      };
    }

    return accumulator;
  }, {});
}

var _default = _postcss.default.plugin(pluginName, () => function process(css, result) {
  const importReplacements = Object.create(null);
  const {
    icssImports,
    icssExports
  } = (0, _icssUtils.extractICSS)(css);
  const normalizedIcssImports = normalizeIcssImports(icssImports);
  Object.keys(normalizedIcssImports).forEach((url, importIndex) => {
    const importName = `___CSS_LOADER_ICSS_IMPORT_${importIndex}___`;
    result.messages.push({
      pluginName,
      type: 'import',
      value: {
        type: 'icss-import',
        importName,
        url
      }
    });
    const tokenMap = normalizedIcssImports[url];
    const tokens = Object.keys(tokenMap);
    tokens.forEach((token, replacementIndex) => {
      const replacementName = `___CSS_LOADER_ICSS_IMPORT_${importIndex}_REPLACEMENT_${replacementIndex}___`;
      const localName = tokenMap[token];
      importReplacements[token] = replacementName;
      result.messages.push({
        pluginName,
        type: 'replacer',
        value: {
          type: 'icss-import',
          importName,
          replacementName,
          localName
<<<<<<< HEAD
<<<<<<< HEAD
>>>>>>> cbaeadb69664be713d49558df22b6f02c48f3384
=======
=======
>>>>>>> bda8256cb (figuring out lint)
=======
=======
>>>>>>> 6be43a322 (figuring out lint)
=======
<<<<<<< HEAD
>>>>>>> cbaeadb69664be713d49558df22b6f02c48f3384
=======
=======
>>>>>>> 5209f27ef (figuring out lint)
var _default = _postcss.default.plugin(pluginName, () => function process(css, result) {
  const imports = {};
  const icss = (0, _icssUtils.extractICSS)(css);
  const exports = icss.icssExports;
  Object.keys(icss.icssImports).forEach(key => {
    const url = _loaderUtils.default.parseString(key);

    Object.keys(icss.icssImports[key]).forEach(prop => {
      const index = Object.keys(imports).length;
      imports[`$${prop}`] = index;
      result.messages.push({
        pluginName,
        type: 'icss-import',
        item: {
          url,
          export: icss.icssImports[key][prop],
          index
        }
      });
      const alreadyIncluded = result.messages.find(message => message.pluginName === pluginName && message.type === 'import' && message.item.url === url && message.item.media === '');

      if (alreadyIncluded) {
        return;
      }

      result.messages.push({
        pluginName,
        type: 'import',
        item: {
          url,
          media: ''
<<<<<<< HEAD
<<<<<<< HEAD
>>>>>>> 6be43a322 (figuring out lint)
=======
>>>>>>> 6be43a322 (figuring out lint)
<<<<<<< HEAD
>>>>>>> 84b8e337c (figuring out lint)
=======
=======
>>>>>>> 6be43a322 (figuring out lint)
>>>>>>> 84b8e337c (figuring out lint)
>>>>>>> 5209f27ef (figuring out lint)
>>>>>>> bda8256cb (figuring out lint)
        }
      });
    });
  });

<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
  function replaceImportsInString(str) {
    const tokens = (0, _postcssValueParser.default)(str);
    tokens.walk(node => {
      if (node.type !== 'word') {
        return;
      }

      const token = node.value;
      const importIndex = imports[`$${token}`];

      if (typeof importIndex === 'number') {
        // eslint-disable-next-line no-param-reassign
        node.value = `___CSS_LOADER_IMPORT___${importIndex}___`;
      }
    });
    return tokens.toString();
  } // Replace tokens in declarations


  css.walkDecls(decl => {
    // eslint-disable-next-line no-param-reassign
    decl.value = replaceImportsInString(decl.value.toString());
  }); // Replace tokens in at-rules

  css.walkAtRules(atrule => {
    // Due reusing `ast` from `postcss-loader` some plugins may lack
    // `params` property, we need to account for this possibility
    if (atrule.params) {
      // eslint-disable-next-line no-param-reassign
      atrule.params = replaceImportsInString(atrule.params.toString());
    }
  }); // Replace tokens in export

  Object.keys(exports).forEach(exportName => {
    result.messages.push({
      pluginName,
      type: 'export',
      item: {
        key: exportName,
        value: replaceImportsInString(exports[exportName])
=======
=======
>>>>>>> 84b8e337c (figuring out lint)
=======
>>>>>>> ee12506f5 (figuring out lint)
=======
>>>>>>> bda8256cb (figuring out lint)
  if (Object.keys(importReplacements).length > 0) {
    (0, _icssUtils.replaceSymbols)(css, importReplacements);
  }

  Object.keys(icssExports).forEach(name => {
    const value = (0, _icssUtils.replaceValueSymbols)(icssExports[name], importReplacements);
    result.messages.push({
      pluginName,
      type: 'export',
      value: {
        name,
        value
<<<<<<< HEAD
>>>>>>> cbaeadb69664be713d49558df22b6f02c48f3384
=======
=======
=======
>>>>>>> 6be43a322 (figuring out lint)
=======
>>>>>>> 5209f27ef (figuring out lint)
  function replaceImportsInString(str) {
    const tokens = (0, _postcssValueParser.default)(str);
    tokens.walk(node => {
      if (node.type !== 'word') {
        return;
      }

      const token = node.value;
      const importIndex = imports[`$${token}`];

      if (typeof importIndex === 'number') {
        // eslint-disable-next-line no-param-reassign
        node.value = `___CSS_LOADER_IMPORT___${importIndex}___`;
      }
    });
    return tokens.toString();
  } // Replace tokens in declarations


  css.walkDecls(decl => {
    // eslint-disable-next-line no-param-reassign
    decl.value = replaceImportsInString(decl.value.toString());
  }); // Replace tokens in at-rules

  css.walkAtRules(atrule => {
    // Due reusing `ast` from `postcss-loader` some plugins may lack
    // `params` property, we need to account for this possibility
    if (atrule.params) {
      // eslint-disable-next-line no-param-reassign
      atrule.params = replaceImportsInString(atrule.params.toString());
    }
  }); // Replace tokens in export

  Object.keys(exports).forEach(exportName => {
    result.messages.push({
      pluginName,
      type: 'export',
      item: {
        key: exportName,
        value: replaceImportsInString(exports[exportName])
<<<<<<< HEAD
>>>>>>> 6be43a322 (figuring out lint)
=======
<<<<<<< HEAD
>>>>>>> 6be43a322 (figuring out lint)
<<<<<<< HEAD
>>>>>>> 84b8e337c (figuring out lint)
=======
=======
=======
>>>>>>> 84b8e337c (figuring out lint)
  if (Object.keys(importReplacements).length > 0) {
    (0, _icssUtils.replaceSymbols)(css, importReplacements);
  }

  Object.keys(icssExports).forEach(name => {
    const value = (0, _icssUtils.replaceValueSymbols)(icssExports[name], importReplacements);
    result.messages.push({
      pluginName,
      type: 'export',
      value: {
        name,
        value
<<<<<<< HEAD
>>>>>>> cbaeadb69664be713d49558df22b6f02c48f3384
=======
=======
  function replaceImportsInString(str) {
    const tokens = (0, _postcssValueParser.default)(str);
    tokens.walk(node => {
      if (node.type !== 'word') {
        return;
      }

      const token = node.value;
      const importIndex = imports[`$${token}`];

      if (typeof importIndex === 'number') {
        // eslint-disable-next-line no-param-reassign
        node.value = `___CSS_LOADER_IMPORT___${importIndex}___`;
      }
    });
    return tokens.toString();
  } // Replace tokens in declarations


  css.walkDecls(decl => {
    // eslint-disable-next-line no-param-reassign
    decl.value = replaceImportsInString(decl.value.toString());
  }); // Replace tokens in at-rules

  css.walkAtRules(atrule => {
    // Due reusing `ast` from `postcss-loader` some plugins may lack
    // `params` property, we need to account for this possibility
    if (atrule.params) {
      // eslint-disable-next-line no-param-reassign
      atrule.params = replaceImportsInString(atrule.params.toString());
    }
  }); // Replace tokens in export

  Object.keys(exports).forEach(exportName => {
    result.messages.push({
      pluginName,
      type: 'export',
      item: {
        key: exportName,
        value: replaceImportsInString(exports[exportName])
>>>>>>> 6be43a322 (figuring out lint)
>>>>>>> 84b8e337c (figuring out lint)
>>>>>>> 5209f27ef (figuring out lint)
>>>>>>> bda8256cb (figuring out lint)
      }
    });
  });
});

exports.default = _default;