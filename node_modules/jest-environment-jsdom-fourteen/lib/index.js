"use strict";
<<<<<<< HEAD
Object.defineProperty(exports, "__esModule", { value: true });
var jest_mock_1 = require("jest-mock");
var jest_util_1 = require("jest-util");
=======
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var jest_util_1 = require("jest-util");
var jest_mock_1 = require("jest-mock");
var fake_timers_1 = require("@jest/fake-timers");
>>>>>>> cbaeadb69664be713d49558df22b6f02c48f3384
var jsdom_1 = require("jsdom");
var JSDOMEnvironment = /** @class */ (function () {
    function JSDOMEnvironment(config, options) {
        if (options === void 0) { options = {}; }
<<<<<<< HEAD
        this.dom = new jsdom_1.JSDOM("<!DOCTYPE html>", Object.assign({
            pretendToBeVisual: true,
            runScripts: "dangerously",
            url: config.testURL,
            virtualConsole: new jsdom_1.VirtualConsole().sendTo(options.console || console),
            resources: options.resources,
        }, config.testEnvironmentOptions));
        this.global = this.dom.window.document.defaultView;
        // Node's error-message stack size is limited at 10, but it's pretty useful
        // to see more than that when a test fails.
        this.global.Error.stackTraceLimit = 100;
        jest_util_1.installCommonGlobals(this.global, config.globals);
=======
        this.dom = new jsdom_1.JSDOM("<!DOCTYPE html>", __assign({ pretendToBeVisual: true, runScripts: "dangerously", url: config.testURL, virtualConsole: new jsdom_1.VirtualConsole().sendTo(options.console || console) }, config.testEnvironmentOptions));
        var global = (this.global = this.dom.window.document.defaultView);
        if (!global) {
            throw new Error("JSDOM did not return a Window object");
        }
        // Node's error-message stack size is limited at 10, but it's pretty useful
        // to see more than that when a test fails.
        this.global.Error.stackTraceLimit = 100;
        jest_util_1.installCommonGlobals(global, config.globals);
>>>>>>> cbaeadb69664be713d49558df22b6f02c48f3384
        // Report uncaught errors.
        this.errorEventListener = function (event) {
            if (userErrorListenerCount === 0 && event.error) {
                process.emit("uncaughtException", event.error);
            }
        };
<<<<<<< HEAD
        this.global.addEventListener("error", this.errorEventListener);
        // However, don't report them as uncaught if the user listens to 'error' event.
        // In that case, we assume the might have custom error handling logic.
        var originalAddListener = this.global.addEventListener;
        var originalRemoveListener = this.global.removeEventListener;
        var userErrorListenerCount = 0;
        this.global.addEventListener = function (name) {
            if (name === "error") {
                userErrorListenerCount++;
            }
            return originalAddListener.apply(this, arguments);
        };
        this.global.removeEventListener = function (name) {
            if (name === "error") {
                userErrorListenerCount--;
            }
            return originalRemoveListener.apply(this, arguments);
        };
        this.moduleMocker = new jest_mock_1.ModuleMocker(this.global);
=======
        global.addEventListener("error", this.errorEventListener);
        // However, don't report them as uncaught if the user listens to 'error' event.
        // In that case, we assume the might have custom error handling logic.
        var originalAddListener = global.addEventListener;
        var originalRemoveListener = global.removeEventListener;
        var userErrorListenerCount = 0;
        global.addEventListener = function () {
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i] = arguments[_i];
            }
            if (args[0] === "error") {
                userErrorListenerCount++;
            }
            return originalAddListener.apply(this, args);
        };
        global.removeEventListener = function () {
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i] = arguments[_i];
            }
            if (args[0] === "error") {
                userErrorListenerCount--;
            }
            return originalRemoveListener.apply(this, args);
        };
        this.moduleMocker = new jest_mock_1.ModuleMocker(global);
>>>>>>> cbaeadb69664be713d49558df22b6f02c48f3384
        var timerConfig = {
            idToRef: function (id) { return id; },
            refToId: function (ref) { return ref; },
        };
<<<<<<< HEAD
        this.fakeTimers = new jest_util_1.FakeTimers({
            config: config,
            global: this.global,
=======
        this.fakeTimers = new fake_timers_1.JestFakeTimers({
            config: config,
            global: global,
>>>>>>> cbaeadb69664be713d49558df22b6f02c48f3384
            moduleMocker: this.moduleMocker,
            timerConfig: timerConfig,
        });
    }
    JSDOMEnvironment.prototype.setup = function () {
        return Promise.resolve();
    };
    JSDOMEnvironment.prototype.teardown = function () {
        if (this.fakeTimers) {
            this.fakeTimers.dispose();
        }
        if (this.global) {
            if (this.errorEventListener) {
                this.global.removeEventListener("error", this.errorEventListener);
            }
            // Dispose "document" to prevent "load" event from triggering.
<<<<<<< HEAD
            Object.defineProperty(this.global, "document", { value: undefined });
            this.global.close();
        }
        this.errorEventListener = undefined;
        this.global = undefined;
        this.dom = undefined;
        this.fakeTimers = undefined;
=======
            Object.defineProperty(this.global, "document", { value: null });
            this.global.close();
        }
        this.errorEventListener = null;
        // @ts-ignore
        this.global = null;
        this.dom = null;
        this.fakeTimers = null;
>>>>>>> cbaeadb69664be713d49558df22b6f02c48f3384
        return Promise.resolve();
    };
    JSDOMEnvironment.prototype.runScript = function (script) {
        if (this.dom) {
            return this.dom.runVMScript(script);
        }
        return null;
    };
    return JSDOMEnvironment;
}());
module.exports = JSDOMEnvironment;
